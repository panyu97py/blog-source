---
title: 'å¯è§†åŒ–æ‹–æ‹½ç»„ä»¶åº“ä¸€äº›æŠ€æœ¯è¦ç‚¹åŸç†åˆ†æï¼ˆä¸‰ï¼‰'
date: 2021-02-17 03:49:47
tags: [vue]
published: true
hideInList: false
feature: 
isTop: false
---
æœ¬æ–‡æ‘˜è‡ª[æ˜é‡‘](https://juejin.cn/post/6929302655118344200),å†™çš„å¾ˆå¥½æŠ„å½•ä¸€ä¸‹ã€‚å»ºè®®å¤šå»ç»™åŸä½œè€…ç‚¹èµğŸ‘


æœ¬æ–‡æ˜¯å¯è§†åŒ–æ‹–æ‹½ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡ï¼Œä¹‹å‰çš„ä¸¤ç¯‡æ–‡ç« ä¸€å…±å¯¹ 17 ä¸ªåŠŸèƒ½ç‚¹çš„æŠ€æœ¯åŸç†è¿›è¡Œäº†åˆ†æï¼š


1. ç¼–è¾‘å™¨
2. è‡ªå®šä¹‰ç»„ä»¶
3. æ‹–æ‹½
4. åˆ é™¤ç»„ä»¶ã€è°ƒæ•´å›¾å±‚å±‚çº§
5. æ”¾å¤§ç¼©å°
6. æ’¤æ¶ˆã€é‡åš
7. ç»„ä»¶å±æ€§è®¾ç½®
8. å¸é™„
9. é¢„è§ˆã€ä¿å­˜ä»£ç 
10. ç»‘å®šäº‹ä»¶
11. ç»‘å®šåŠ¨ç”»
12. å¯¼å…¥ PSD
13. æ‰‹æœºæ¨¡å¼
14. æ‹–æ‹½æ—‹è½¬ 
15. å¤åˆ¶ç²˜è´´å‰ªåˆ‡
16. æ•°æ®äº¤äº’
17. å‘å¸ƒ

æœ¬æ–‡åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå°†å¯¹ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ç‚¹çš„æŠ€æœ¯åŸç†è¿›è¡Œåˆ†æï¼š

18. å¤šä¸ªç»„ä»¶çš„ç»„åˆå’Œæ‹†åˆ†
19. æ–‡æœ¬ç»„ä»¶
20. çŸ©å½¢ç»„ä»¶
21. é”å®šç»„ä»¶
22. å¿«æ·é”®
23. ç½‘æ ¼çº¿
24. ç¼–è¾‘å™¨å¿«ç…§çš„å¦ä¸€ç§å®ç°æ–¹å¼

è™½ç„¶æˆ‘è¿™ä¸ªå¯è§†åŒ–æ‹–æ‹½ç»„ä»¶åº“åªæ˜¯ä¸€ä¸ª DEMOï¼Œä½†å¯¹æ¯”äº†ä¸€ä¸‹å¸‚é¢ä¸Šçš„ä¸€äº›ç°æˆäº§å“ï¼ˆä¾‹å¦‚ [processon](https://www.processon.com/)ã€[å¢¨åˆ€](https://modao.cc/)ï¼‰ï¼Œå°±åŸºç¡€åŠŸèƒ½æ¥è¯´ï¼Œæˆ‘è¿™ä¸ª DEMO å®ç°äº†ç»å¤§éƒ¨åˆ†çš„åŠŸèƒ½ã€‚
å¦‚æœä½ å¯¹äºä½ä»£ç å¹³å°æœ‰å…´è¶£ï¼Œä½†åˆä¸äº†è§£çš„è¯ã€‚å¼ºçƒˆå»ºè®®å°†æˆ‘çš„ä¸‰ç¯‡æ–‡ç« ç»“åˆé¡¹ç›®æºç ä¸€èµ·é˜…è¯»ï¼Œç›¸ä¿¡å¯¹ä½ çš„æ”¶è·ç»å¯¹ä¸å°ã€‚å¦é™„ä¸Šé¡¹ç›®ã€åœ¨çº¿ DEMO åœ°å€ï¼š

[github é¡¹ç›®åœ°å€](https://github.com/woai3c/visual-drag-demo)

[åœ¨çº¿é¢„è§ˆ](https://woai3c.github.io/visual-drag-demo/#/)

### 18. å¤šä¸ªç»„ä»¶çš„ç»„åˆå’Œæ‹†åˆ†

ç»„åˆå’Œæ‹†åˆ†çš„æŠ€æœ¯ç‚¹ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå¤šï¼Œå…±æœ‰ä»¥ä¸‹ 4 ä¸ªï¼š

* é€‰ä¸­åŒºåŸŸ
* ç»„åˆåçš„ç§»åŠ¨ã€æ—‹è½¬
* ç»„åˆåçš„æ”¾å¤§ç¼©å°
* æ‹†åˆ†åå­ç»„ä»¶æ ·å¼çš„æ¢å¤

#### é€‰ä¸­åŒºåŸŸ
åœ¨å°†å¤šä¸ªç»„ä»¶ç»„åˆä¹‹å‰ï¼Œéœ€è¦å…ˆé€‰ä¸­å®ƒä»¬ã€‚åˆ©ç”¨é¼ æ ‡äº‹ä»¶å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†é€‰ä¸­åŒºåŸŸå±•ç¤ºå‡ºæ¥ï¼š

![](https://panyu97py.github.io/post-images/1613505365488.gif)

1. `mousedown` è®°å½•èµ·ç‚¹åæ ‡
2. `mousemove` å°†å½“å‰åæ ‡å’Œèµ·ç‚¹åæ ‡è¿›è¡Œè®¡ç®—å¾—å‡ºç§»åŠ¨åŒºåŸŸ
3. å¦‚æœæŒ‰ä¸‹é¼ æ ‡åå¾€å·¦ä¸Šæ–¹ç§»åŠ¨ï¼Œç±»ä¼¼äºè¿™ç§æ“ä½œåˆ™éœ€è¦å°†å½“å‰åæ ‡è®¾ä¸ºèµ·ç‚¹åæ ‡ï¼Œå†è®¡ç®—å‡ºç§»åŠ¨åŒºåŸŸ

``` js
// è·å–ç¼–è¾‘å™¨çš„ä½ç§»ä¿¡æ¯
const rectInfo = this.editor.getBoundingClientRect()
this.editorX = rectInfo.x
this.editorY = rectInfo.y

const startX = e.clientX
const startY = e.clientY
this.start.x = startX - this.editorX
this.start.y = startY - this.editorY
// å±•ç¤ºé€‰ä¸­åŒºåŸŸ
this.isShowArea = true

const move = (moveEvent) => {
    this.width = Math.abs(moveEvent.clientX - startX)
    this.height = Math.abs(moveEvent.clientY - startY)
    if (moveEvent.clientX < startX) {
        this.start.x = moveEvent.clientX - this.editorX
    }

    if (moveEvent.clientY < startY) {
        this.start.y = moveEvent.clientY - this.editorY
    }
}
```
åœ¨ mouseup äº‹ä»¶è§¦å‘æ—¶ï¼Œéœ€è¦å¯¹é€‰ä¸­åŒºåŸŸå†…çš„æ‰€æœ‰ç»„ä»¶çš„ä½ç§»å¤§å°ä¿¡æ¯è¿›è¡Œè®¡ç®—ï¼Œå¾—å‡ºä¸€ä¸ªèƒ½åŒ…å«åŒºåŸŸå†…æ‰€æœ‰ç»„ä»¶çš„æœ€å°åŒºåŸŸã€‚è¿™ä¸ªæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://panyu97py.github.io/post-images/1613505466651.gif)

è¿™ä¸ªè®¡ç®—è¿‡ç¨‹çš„ä»£ç ï¼š

```js
createGroup() {
  // è·å–é€‰ä¸­åŒºåŸŸçš„ç»„ä»¶æ•°æ®
  const areaData = this.getSelectArea()
  if (areaData.length <= 1) {
      this.hideArea()
      return
  }

  // æ ¹æ®é€‰ä¸­åŒºåŸŸå’ŒåŒºåŸŸä¸­æ¯ä¸ªç»„ä»¶çš„ä½ç§»ä¿¡æ¯æ¥åˆ›å»º Group ç»„ä»¶
  // è¦éå†é€‰æ‹©åŒºåŸŸçš„æ¯ä¸ªç»„ä»¶ï¼Œè·å–å®ƒä»¬çš„ left top right bottom ä¿¡æ¯æ¥è¿›è¡Œæ¯”è¾ƒ
  let top = Infinity, left = Infinity
  let right = -Infinity, bottom = -Infinity
  areaData.forEach(component => {
      let style = {}
      if (component.component == 'Group') {
          component.propValue.forEach(item => {
              const rectInfo = $(`#component${item.id}`).getBoundingClientRect()
              style.left = rectInfo.left - this.editorX
              style.top = rectInfo.top - this.editorY
              style.right = rectInfo.right - this.editorX
              style.bottom = rectInfo.bottom - this.editorY

              if (style.left < left) left = style.left
              if (style.top < top) top = style.top
              if (style.right > right) right = style.right
              if (style.bottom > bottom) bottom = style.bottom
          })
      } else {
          style = getComponentRotatedStyle(component.style)
      }

      if (style.left < left) left = style.left
      if (style.top < top) top = style.top
      if (style.right > right) right = style.right
      if (style.bottom > bottom) bottom = style.bottom
  })

  this.start.x = left
  this.start.y = top
  this.width = right - left
  this.height = bottom - top
	
  // è®¾ç½®é€‰ä¸­åŒºåŸŸä½ç§»å¤§å°ä¿¡æ¯å’ŒåŒºåŸŸå†…çš„ç»„ä»¶æ•°æ®
  this.$store.commit('setAreaData', {
      style: {
          left,
          top,
          width: this.width,
          height: this.height,
      },
      components: areaData,
  })
},
        
getSelectArea() {
    const result = []
    // åŒºåŸŸèµ·ç‚¹åæ ‡
    const { x, y } = this.start
    // è®¡ç®—æ‰€æœ‰çš„ç»„ä»¶æ•°æ®ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨é€‰ä¸­åŒºåŸŸå†…
    this.componentData.forEach(component => {
        if (component.isLock) return
        const { left, top, width, height } = component.style
        if (x <= left && y <= top && (left + width <= x + this.width) && (top + height <= y + this.height)) {
            result.push(component)
        }
    })
	
    // è¿”å›åœ¨é€‰ä¸­åŒºåŸŸå†…çš„æ‰€æœ‰ç»„ä»¶
    return result
}
```
ç®€å•æè¿°ä¸€ä¸‹è¿™æ®µä»£ç çš„å¤„ç†é€»è¾‘ï¼š

1. åˆ©ç”¨ [`getBoundingClientRect()`](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect) æµè§ˆå™¨ API è·å–æ¯ä¸ªç»„ä»¶ç›¸å¯¹äºæµè§ˆå™¨è§†å£å››ä¸ªæ–¹å‘ä¸Šçš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯`left`ã€`top`ã€`right`ã€`bottom`ã€‚
2. å¯¹æ¯”æ¯ä¸ªç»„ä»¶çš„è¿™å››ä¸ªä¿¡æ¯ï¼Œå–å¾—é€‰ä¸­åŒºåŸŸçš„æœ€å·¦ã€æœ€ä¸Šã€æœ€å³ã€æœ€ä¸‹å››ä¸ªæ–¹å‘çš„æ•°å€¼ï¼Œä»è€Œå¾—å‡ºä¸€ä¸ªèƒ½åŒ…å«åŒºåŸŸå†…æ‰€æœ‰ç»„ä»¶çš„æœ€å°åŒºåŸŸã€‚
3. å¦‚æœé€‰ä¸­åŒºåŸŸå†…å·²ç»æœ‰ä¸€ä¸ª `Group` ç»„åˆç»„ä»¶ï¼Œåˆ™éœ€è¦å¯¹å®ƒé‡Œé¢çš„å­ç»„ä»¶è¿›è¡Œè®¡ç®—ï¼Œè€Œä¸æ˜¯å¯¹ç»„åˆç»„ä»¶è¿›è¡Œè®¡ç®—ã€‚

#### ç»„åˆåçš„ç§»åŠ¨ã€æ—‹è½¬

ä¸ºäº†æ–¹ä¾¿å°†å¤šä¸ªç»„ä»¶ä¸€èµ·è¿›è¡Œç§»åŠ¨ã€æ—‹è½¬ã€æ”¾å¤§ç¼©å°ç­‰æ“ä½œï¼Œæˆ‘æ–°åˆ›å»ºäº†ä¸€ä¸ª `Group` ç»„åˆç»„ä»¶ï¼š

```html
<template>
    <div class="group">
        <div>
             <template v-for="item in propValue">
                <component
                    class="component"
                    :is="item.component"
                    :style="item.groupStyle"
                    :propValue="item.propValue"
                    :key="item.id"
                    :id="'component' + item.id"
                    :element="item"
                />
            </template>
        </div>
    </div>
</template>

<script>
import { getStyle } from '@/utils/style'

export default {
    props: {
        propValue: {
            type: Array,
            default: () => [],
        },
        element: {
            type: Object,
        },
    },
    created() {
        const parentStyle = this.element.style
        this.propValue.forEach(component => {
            // component.groupStyle çš„ top left æ˜¯ç›¸å¯¹äº group ç»„ä»¶çš„ä½ç½®
            // å¦‚æœå·²å­˜åœ¨ component.groupStyleï¼Œè¯´æ˜å·²ç»è®¡ç®—è¿‡ä¸€æ¬¡äº†ã€‚ä¸éœ€è¦å†æ¬¡è®¡ç®—
            if (!Object.keys(component.groupStyle).length) {
                const style = { ...component.style }
                component.groupStyle = getStyle(style)
                component.groupStyle.left = this.toPercent((style.left - parentStyle.left) / parentStyle.width)
                component.groupStyle.top = this.toPercent((style.top - parentStyle.top) / parentStyle.height)
                component.groupStyle.width = this.toPercent(style.width / parentStyle.width)
                component.groupStyle.height = this.toPercent(style.height / parentStyle.height)
            }
        })
    },
    methods: {
        toPercent(val) {
            return val * 100 + '%'
        },
    },
}
</script>

<style lang="scss" scoped>
.group {
    & > div {
        position: relative;
        width: 100%;
        height: 100%;

        .component {
            position: absolute;
        }
    }
}
</style>
```

`Group` ç»„ä»¶çš„ä½œç”¨å°±æ˜¯å°†åŒºåŸŸå†…çš„ç»„ä»¶æ”¾åˆ°å®ƒä¸‹é¢ï¼Œæˆä¸ºå­ç»„ä»¶ã€‚å¹¶ä¸”åœ¨åˆ›å»º `Group` ç»„ä»¶æ—¶ï¼Œè·å–æ¯ä¸ªå­ç»„ä»¶åœ¨ `Group` ç»„ä»¶å†…çš„ç›¸å¯¹ä½ç§»å’Œç›¸å¯¹å¤§å°ï¼š

```js
created() {
    const parentStyle = this.element.style
    this.propValue.forEach(component => {
        // component.groupStyle çš„ top left æ˜¯ç›¸å¯¹äº group ç»„ä»¶çš„ä½ç½®
        // å¦‚æœå·²å­˜åœ¨ component.groupStyleï¼Œè¯´æ˜å·²ç»è®¡ç®—è¿‡ä¸€æ¬¡äº†ã€‚ä¸éœ€è¦å†æ¬¡è®¡ç®—
        if (!Object.keys(component.groupStyle).length) {
            const style = { ...component.style }
            component.groupStyle = getStyle(style)
            component.groupStyle.left = this.toPercent((style.left - parentStyle.left) / parentStyle.width)
            component.groupStyle.top = this.toPercent((style.top - parentStyle.top) / parentStyle.height)
            component.groupStyle.width = this.toPercent(style.width / parentStyle.width)
            component.groupStyle.height = this.toPercent(style.height / parentStyle.height)
        }
    })
},
methods: {
        toPercent(val) {
            return val * 100 + '%'
        },
    },
```

ä¹Ÿå°±æ˜¯å°†å­ç»„ä»¶çš„ `left`ã€`top`ã€`right`ã€`bottom` ç­‰å±æ€§è½¬æˆä»¥ `%` ç»“å°¾çš„ç›¸å¯¹æ•°å€¼ã€‚


**ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ç»å¯¹æ•°å€¼ï¼Ÿ**


å¦‚æœä½¿ç”¨ç»å¯¹æ•°å€¼ï¼Œé‚£ä¹ˆåœ¨ç§»åŠ¨ `Group` ç»„ä»¶æ—¶ï¼Œé™¤äº†å¯¹ `Group` ç»„ä»¶çš„å±æ€§è¿›è¡Œè®¡ç®—å¤–ï¼Œè¿˜éœ€è¦å¯¹å®ƒçš„æ¯ä¸ªå­ç»„ä»¶è¿›è¡Œè®¡ç®—ã€‚å¹¶ä¸” `Group` åŒ…å«å­ç»„ä»¶å¤ªå¤šçš„è¯ï¼Œåœ¨è¿›è¡Œç§»åŠ¨ã€æ”¾å¤§ç¼©å°æ—¶ï¼Œè®¡ç®—é‡ä¼šéå¸¸å¤§ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆé¡µé¢å¡é¡¿ã€‚å¦‚æœæ”¹æˆç›¸å¯¹æ•°å€¼ï¼Œåˆ™åªéœ€è¦åœ¨ `Group` åˆ›å»ºæ—¶è®¡ç®—ä¸€æ¬¡ã€‚ç„¶ååœ¨ `Group` ç»„ä»¶è¿›è¡Œç§»åŠ¨ã€æ—‹è½¬æ—¶ä¹Ÿä¸ç”¨ç®¡ `Group` çš„å­ç»„ä»¶ï¼Œåªå¯¹å®ƒè‡ªå·±è®¡ç®—å³å¯ã€‚

![](https://panyu97py.github.io/post-images/1613505786018.gif)

#### ç»„åˆåçš„æ”¾å¤§ç¼©å°

ç»„åˆåçš„æ”¾å¤§ç¼©å°æ˜¯ä¸ªå¤§é—®é¢˜ï¼Œä¸»è¦æ˜¯å› ä¸ºæœ‰æ—‹è½¬è§’åº¦çš„å­˜åœ¨ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹å„ä¸ªå­ç»„ä»¶æ²¡æ—‹è½¬æ—¶çš„æ”¾å¤§ç¼©å°ï¼š

![](https://panyu97py.github.io/post-images/1613505848014.gif)

ä»åŠ¨å›¾å¯ä»¥çœ‹å‡ºï¼Œæ•ˆæœéå¸¸å®Œç¾ã€‚å„ä¸ªå­ç»„ä»¶çš„å¤§å°æ˜¯è·Ÿéš `Group` ç»„ä»¶çš„å¤§å°è€Œæ”¹å˜çš„ã€‚

ç°åœ¨è¯•ç€ç»™å­ç»„ä»¶åŠ ä¸Šæ—‹è½¬è§’åº¦ï¼Œå†çœ‹ä¸€ä¸‹æ•ˆæœï¼š

![](https://panyu97py.github.io/post-images/1613505895886.gif)

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ
ä¸»è¦æ˜¯å› ä¸ºä¸€ä¸ªç»„ä»¶æ— è®ºæ—‹ä¸æ—‹è½¬ï¼Œå®ƒçš„ `left`ã€`top` å±æ€§éƒ½æ˜¯ä¸å˜çš„ã€‚è¿™æ ·å°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè™½ç„¶å®é™…ä¸Šç»„ä»¶çš„  `left`ã€`top`ã€`right`ã€`bottom`  å±æ€§æ²¡æœ‰å˜åŒ–ã€‚ä½†åœ¨å¤–è§‚ä¸Šå´å‘ç”Ÿäº†å˜åŒ–ã€‚ä¸‹é¢æ˜¯ä¸¤ä¸ªåŒæ ·çš„ç»„ä»¶ï¼šä¸€ä¸ªæ²¡æ—‹è½¬ï¼Œä¸€ä¸ªæ—‹è½¬äº† 45 åº¦ã€‚

![](https://panyu97py.github.io/post-images/1613505976304.png)
å¯ä»¥çœ‹å‡ºæ¥æ—‹è½¬åæŒ‰é’®çš„`left`ã€`top`ã€`right`ã€`bottom` å±æ€§å’Œæˆ‘ä»¬ä»å¤–è§‚ä¸Šçœ‹åˆ°çš„æ˜¯ä¸ä¸€æ ·çš„ã€‚

æ¥ä¸‹æ¥å†çœ‹ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹ï¼š


![](https://panyu97py.github.io/post-images/1613506012073.png)

ä¸Šé¢æ˜¯ä¸€ä¸ª `Group` ç»„ä»¶ï¼Œå®ƒå·¦è¾¹çš„å­ç»„ä»¶å±æ€§ä¸ºï¼š

```css
transform: rotate(-75.1967deg);
width: 51.2267%;
height: 32.2679%;
top: 33.8661%;
left: -10.6496%;
```

å¯ä»¥çœ‹åˆ° `width` çš„å€¼ä¸º `51.2267%`ï¼Œä½†ä»å¤–è§‚ä¸Šæ¥çœ‹ï¼Œè¿™ä¸ªå­ç»„ä»¶æœ€å¤šå  `Group` ç»„ä»¶å®½åº¦çš„ä¸‰åˆ†ä¹‹ä¸€ã€‚æ‰€ä»¥è¿™å°±æ˜¯æ”¾å¤§ç¼©å°ä¸æ­£å¸¸çš„é—®é¢˜æ‰€åœ¨ã€‚

##### ä¸€ä¸ªä¸å¯è¡Œçš„è§£å†³æ–¹æ¡ˆï¼ˆä¸æƒ³çœ‹çš„å¯ä»¥è·³è¿‡ï¼‰


ä¸€å¼€å§‹æˆ‘æƒ³çš„æ˜¯ï¼Œå…ˆç®—å‡ºå®ƒç›¸å¯¹æµè§ˆå™¨è§†å£çš„ `left`ã€`top`ã€`right`ã€`bottom` å±æ€§ï¼Œå†ç®—å‡ºè¿™å‡ ä¸ªå±æ€§åœ¨ `Group` ç»„ä»¶ä¸Šçš„ç›¸å¯¹æ•°å€¼ã€‚è¿™å¯ä»¥é€šè¿‡ `getBoundingClientRect()` `API` å®ç°ã€‚åªè¦ç»´æŒå¤–è§‚ä¸Šçš„å„ä¸ªå±æ€§å æ¯”ä¸å˜ï¼Œè¿™æ · `Group` ç»„ä»¶åœ¨æ”¾å¤§ç¼©å°æ—¶ï¼Œå†é€šè¿‡æ—‹è½¬è§’åº¦ï¼Œåˆ©ç”¨æ—‹è½¬çŸ©é˜µçš„çŸ¥è¯†ï¼ˆè¿™ä¸€ç‚¹åœ¨ç¬¬äºŒç¯‡æœ‰è¯¦ç»†æè¿°ï¼‰è·å–å®ƒæœªæ—‹è½¬å‰çš„ t`left`ã€`top`ã€`right`ã€`bottom`  å±æ€§ã€‚è¿™æ ·å°±å¯ä»¥åšåˆ°å­ç»„ä»¶åŠ¨æ€è°ƒæ•´äº†ã€‚


ä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜ï¼Œé€šè¿‡ `getBoundingClientRect()` API åªèƒ½è·å–ç»„ä»¶å¤–è§‚ä¸Šçš„ `left`ã€`top`ã€`right`ã€`bottom`  å±æ€§ã€‚å†åŠ ä¸Šä¸€ä¸ªè§’åº¦ï¼Œå‚æ•°è¿˜æ˜¯ä¸å¤Ÿï¼Œæ‰€ä»¥æ— æ³•è®¡ç®—å‡ºç»„ä»¶å®é™…çš„ `left`ã€`top`ã€`right`ã€`bottom`  å±æ€§ã€‚

![](https://panyu97py.github.io/post-images/1613506253945.png)

å°±åƒä¸Šé¢çš„è¿™å¼ å›¾ï¼ŒåªçŸ¥é“åŸç‚¹` O(x,y)`ã€ `w`ã€`h` å’Œæ—‹è½¬è§’åº¦ï¼Œæ— æ³•ç®—å‡ºæŒ‰é’®çš„å®½é«˜ã€‚

#### ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆ

è¿™æ˜¯æ— æ„ä¸­å‘ç°çš„ï¼Œæˆ‘åœ¨å¯¹ `Group` ç»„ä»¶è¿›è¡Œæ”¾å¤§ç¼©å°æ—¶ï¼Œå‘ç°åªè¦ä¿æŒ `Group` ç»„ä»¶çš„å®½é«˜æ¯”ä¾‹ï¼Œå­ç»„ä»¶å°±èƒ½åšåˆ°æ ¹æ®æ¯”ä¾‹æ”¾å¤§ç¼©å°ã€‚é‚£ä¹ˆç°åœ¨é—®é¢˜å°±è½¬å˜æˆäº†å¦‚ä½•è®© `Group` ç»„ä»¶æ”¾å¤§ç¼©å°æ—¶ä¿æŒå®½é«˜æ¯”ä¾‹ã€‚æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†è¿™ä¸€ç¯‡[æ–‡ç« ](https://github.com/shenhudong/snapping-demo/wiki/corner-handle)ï¼Œå®ƒè¯¦ç»†æè¿°äº†ä¸€ä¸ªæ—‹è½¬ç»„ä»¶å¦‚ä½•ä¿æŒå®½é«˜æ¯”æ¥è¿›è¡Œæ”¾å¤§ç¼©å°ï¼Œå¹¶é…æœ‰æºç ç¤ºä¾‹ã€‚

ç°åœ¨æˆ‘å°è¯•ç®€å•æè¿°ä¸€ä¸‹å¦‚ä½•ä¿æŒå®½é«˜æ¯”å¯¹ä¸€ä¸ªæ—‹è½¬ç»„ä»¶è¿›è¡Œæ”¾å¤§ç¼©å°ï¼ˆå»ºè®®è¿˜æ˜¯çœ‹çœ‹åŸæ–‡ï¼‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå·²æ—‹è½¬ä¸€å®šè§’åº¦çš„çŸ©å½¢ï¼Œå‡è®¾ç°åœ¨æ‹–åŠ¨å®ƒå·¦ä¸Šæ–¹çš„ç‚¹è¿›è¡Œæ‹‰ä¼¸ã€‚

![](https://panyu97py.github.io/post-images/1613506394348.png)

**ç¬¬ä¸€æ­¥**ï¼Œç®—å‡ºç»„ä»¶å®½é«˜æ¯”ï¼Œä»¥åŠæŒ‰ä¸‹é¼ æ ‡æ—¶é€šè¿‡ç»„ä»¶çš„åæ ‡ï¼ˆæ— è®ºæ—‹è½¬å¤šå°‘åº¦ï¼Œç»„ä»¶çš„ `top` ã€`left` å±æ€§ä¸å˜ï¼‰å’Œå¤§å°ç®—å‡ºç»„ä»¶ä¸­å¿ƒç‚¹ï¼š
```js
// ç»„ä»¶å®½é«˜æ¯”
const proportion = style.width / style.height
            
const center = {
    x: style.left + style.width / 2,
    y: style.top + style.height / 2,
}
```

**ç¬¬äºŒæ­¥**ï¼Œç”¨å½“å‰ç‚¹å‡»åæ ‡å’Œç»„ä»¶ä¸­å¿ƒç‚¹ç®—å‡ºå½“å‰ç‚¹å‡»åæ ‡çš„å¯¹ç§°ç‚¹åæ ‡ï¼š
```js
// è·å–ç”»å¸ƒä½ç§»ä¿¡æ¯
const editorRectInfo = document.querySelector('#editor').getBoundingClientRect()

// å½“å‰ç‚¹å‡»åæ ‡
const curPoint = {
    x: e.clientX - editorRectInfo.left,
    y: e.clientY - editorRectInfo.top,
}

// è·å–å¯¹ç§°ç‚¹çš„åæ ‡
const symmetricPoint = {
    x: center.x - (curPoint.x - center.x),
    y: center.y - (curPoint.y - center.y),
}
```
**ç¬¬ä¸‰æ­¥**ï¼Œæ‘ä½ç»„ä»¶å·¦ä¸Šè§’è¿›è¡Œæ‹‰ä¼¸æ—¶ï¼Œé€šè¿‡å½“å‰é¼ æ ‡å®æ—¶åæ ‡å’Œå¯¹ç§°ç‚¹è®¡ç®—å‡ºæ–°çš„ç»„ä»¶ä¸­å¿ƒç‚¹ï¼š
```js
const curPositon = {
    x: moveEvent.clientX - editorRectInfo.left,
    y: moveEvent.clientY - editorRectInfo.top,
}

const newCenterPoint = getCenterPoint(curPositon, symmetricPoint)

// æ±‚ä¸¤ç‚¹ä¹‹é—´çš„ä¸­ç‚¹åæ ‡
function getCenterPoint(p1, p2) {
    return {
        x: p1.x + ((p2.x - p1.x) / 2),
        y: p1.y + ((p2.y - p1.y) / 2),
    }
}
```
ç”±äºç»„ä»¶å¤„äºæ—‹è½¬çŠ¶æ€ï¼Œå³ä½¿ä½ çŸ¥é“äº†æ‹‰ä¼¸æ—¶ç§»åŠ¨çš„ xy è·ç¦»ï¼Œä¹Ÿä¸èƒ½ç›´æ¥å¯¹ç»„ä»¶è¿›è¡Œè®¡ç®—ã€‚å¦åˆ™å°±ä¼šå‡ºç° BUGï¼Œç§»ä½æˆ–è€…æ”¾å¤§ç¼©å°æ–¹å‘ä¸æ­£ç¡®ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç»„ä»¶æœªæ—‹è½¬çš„æƒ…å†µä¸‹å¯¹å…¶è¿›è¡Œè®¡ç®—ã€‚

![](https://panyu97py.github.io/post-images/1613506539352.png)

**ç¬¬å››æ­¥**ï¼Œæ ¹æ®å·²çŸ¥çš„æ—‹è½¬è§’åº¦ã€æ–°çš„ç»„ä»¶ä¸­å¿ƒç‚¹ã€å½“å‰é¼ æ ‡å®æ—¶åæ ‡å¯ä»¥ç®—å‡ºå½“å‰é¼ æ ‡å®æ—¶åæ ‡ `currentPosition` åœ¨æœªæ—‹è½¬æ—¶çš„åæ ‡ `newTopLeftPoint`ã€‚åŒæ—¶ä¹Ÿèƒ½æ ¹æ®å·²çŸ¥çš„æ—‹è½¬è§’åº¦ã€æ–°çš„ç»„ä»¶ä¸­å¿ƒç‚¹ã€å¯¹ç§°ç‚¹ç®—å‡ºç»„ä»¶å¯¹ç§°ç‚¹ sPoint åœ¨æœªæ—‹è½¬æ—¶çš„åæ ‡ `newBottomRightPoint`ã€‚
å¯¹åº”çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

```js
/**
 * è®¡ç®—æ ¹æ®åœ†å¿ƒæ—‹è½¬åçš„ç‚¹çš„åæ ‡
 * @param   {Object}  point  æ—‹è½¬å‰çš„ç‚¹åæ ‡
 * @param   {Object}  center æ—‹è½¬ä¸­å¿ƒ
 * @param   {Number}  rotate æ—‹è½¬çš„è§’åº¦
 * @return  {Object}         æ—‹è½¬åçš„åæ ‡
 * https://www.zhihu.com/question/67425734/answer/252724399 æ—‹è½¬çŸ©é˜µå…¬å¼
 */
export function calculateRotatedPointCoordinate(point, center, rotate) {
    /**
     * æ—‹è½¬å…¬å¼ï¼š
     *  ç‚¹a(x, y)
     *  æ—‹è½¬ä¸­å¿ƒc(x, y)
     *  æ—‹è½¬åç‚¹n(x, y)
     *  æ—‹è½¬è§’åº¦Î¸                tan ??
     * nx = cosÎ¸ * (ax - cx) - sinÎ¸ * (ay - cy) + cx
     * ny = sinÎ¸ * (ax - cx) + cosÎ¸ * (ay - cy) + cy
     */

    return {
        x: (point.x - center.x) * Math.cos(angleToRadian(rotate)) - (point.y - center.y) * Math.sin(angleToRadian(rotate)) + center.x,
        y: (point.x - center.x) * Math.sin(angleToRadian(rotate)) + (point.y - center.y) * Math.cos(angleToRadian(rotate)) + center.y,
    }
}
```

ä¸Šé¢çš„å…¬å¼æ¶‰åŠåˆ°çº¿æ€§ä»£æ•°ä¸­æ—‹è½¬çŸ©é˜µçš„çŸ¥è¯†ï¼Œå¯¹äºä¸€ä¸ªæ²¡ä¸Šè¿‡å¤§å­¦çš„äººæ¥è¯´ï¼Œå®åœ¨å¤ªéš¾äº†ã€‚è¿˜å¥½æˆ‘ä»[çŸ¥ä¹ä¸Šçš„ä¸€ä¸ªå›ç­”](https://www.zhihu.com/question/67425734/answer/252724399)ä¸­æ‰¾åˆ°äº†è¿™ä¸€å…¬å¼çš„æ¨ç†è¿‡ç¨‹ï¼Œä¸‹é¢æ˜¯å›ç­”çš„åŸæ–‡ï¼š

![](https://panyu97py.github.io/post-images/1613506660740.png)

![](https://panyu97py.github.io/post-images/1613506688090.png)

é€šè¿‡ä»¥ä¸Šå‡ ä¸ªè®¡ç®—å€¼ï¼Œå°±å¯ä»¥å¾—åˆ°ç»„ä»¶æ–°çš„ä½ç§»å€¼ `top`ã€`left` ä»¥åŠæ–°çš„ç»„ä»¶å¤§å°ã€‚å¯¹åº”çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
```js
function calculateLeftTop(style, curPositon, pointInfo) {
    const { symmetricPoint } = pointInfo
    const newCenterPoint = getCenterPoint(curPositon, symmetricPoint)
    const newTopLeftPoint = calculateRotatedPointCoordinate(curPositon, newCenterPoint, -style.rotate)
    const newBottomRightPoint = calculateRotatedPointCoordinate(symmetricPoint, newCenterPoint, -style.rotate)
  
    const newWidth = newBottomRightPoint.x - newTopLeftPoint.x
    const newHeight = newBottomRightPoint.y - newTopLeftPoint.y
    if (newWidth > 0 && newHeight > 0) {
        style.width = Math.round(newWidth)
        style.height = Math.round(newHeight)
        style.left = Math.round(newTopLeftPoint.x)
        style.top = Math.round(newTopLeftPoint.y)
    }
}
```
ç°åœ¨å†æ¥çœ‹ä¸€ä¸‹æ—‹è½¬åçš„æ”¾å¤§ç¼©å°ï¼š

![](https://panyu97py.github.io/post-images/1613506759227.gif)

**ç¬¬äº”æ­¥**ï¼Œç”±äºæˆ‘ä»¬ç°åœ¨éœ€è¦çš„æ˜¯é”å®šå®½é«˜æ¯”æ¥è¿›è¡Œæ”¾å¤§ç¼©å°ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®¡ç®—æ‹‰ä¼¸åçš„å›¾å½¢çš„å·¦ä¸Šè§’åæ ‡ã€‚

è¿™é‡Œå…ˆç¡®å®šå¥½å‡ ä¸ªå½¢çŠ¶çš„å‘½åï¼š

* åŸå›¾å½¢: ã€€çº¢è‰²éƒ¨åˆ†
* æ–°å›¾å½¢: ã€€è“è‰²éƒ¨åˆ†
* ä¿®æ­£å›¾å½¢: ç»¿è‰²éƒ¨åˆ†ï¼Œå³åŠ ä¸Šå®½é«˜æ¯”é”å®šè§„åˆ™çš„ä¿®æ­£å›¾å½¢

![](https://panyu97py.github.io/post-images/1613506825223.gif)

åœ¨ç¬¬å››æ­¥ä¸­ç®—å‡ºç»„ä»¶æœªæ—‹è½¬å‰çš„ `newTopLeftPoint` `newBottomRightPoint` `newWidth` `newHeight` åï¼Œéœ€è¦æ ¹æ®å®½é«˜æ¯” `proportion` æ¥ç®—å‡ºæ–°çš„å®½åº¦æˆ–é«˜åº¦ã€‚

![](https://panyu97py.github.io/post-images/1613506905389.png)

ä¸Šå›¾å°±æ˜¯ä¸€ä¸ªéœ€è¦æ”¹å˜é«˜åº¦çš„ç¤ºä¾‹ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š

```js
if (newWidth / newHeight > proportion) {
    newTopLeftPoint.x += Math.abs(newWidth - newHeight * proportion)
    newWidth = newHeight * proportion
} else {
    newTopLeftPoint.y += Math.abs(newHeight - newWidth / proportion)
    newHeight = newWidth / proportion
}
```
ç”±äºç°åœ¨æ±‚çš„æœªæ—‹è½¬å‰çš„åæ ‡æ˜¯ä»¥æ²¡æŒ‰æ¯”ä¾‹ç¼©å‡å®½é«˜å‰çš„åæ ‡æ¥è®¡ç®—çš„ï¼Œæ‰€ä»¥ç¼©å‡å®½é«˜åï¼Œéœ€è¦æŒ‰ç…§åŸæ¥çš„ä¸­å¿ƒç‚¹æ—‹è½¬å›å»ï¼Œè·å¾—ç¼©å‡å®½é«˜å¹¶æ—‹è½¬åå¯¹åº”çš„åæ ‡ã€‚ç„¶åä»¥è¿™ä¸ªåæ ‡å’Œå¯¹ç§°ç‚¹è·å¾—æ–°çš„ä¸­å¿ƒç‚¹ï¼Œå¹¶é‡æ–°è®¡ç®—æœªæ—‹è½¬å‰çš„åæ ‡ã€‚

![](https://panyu97py.github.io/post-images/1613506955962.png)

![](https://panyu97py.github.io/post-images/1613507009595.png)

ç»è¿‡ä¿®æ”¹åçš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```js
function calculateLeftTop(style, curPositon, proportion, needLockProportion, pointInfo) {
    const { symmetricPoint } = pointInfo
    let newCenterPoint = getCenterPoint(curPositon, symmetricPoint)
    let newTopLeftPoint = calculateRotatedPointCoordinate(curPositon, newCenterPoint, -style.rotate)
    let newBottomRightPoint = calculateRotatedPointCoordinate(symmetricPoint, newCenterPoint, -style.rotate)
  
    let newWidth = newBottomRightPoint.x - newTopLeftPoint.x
    let newHeight = newBottomRightPoint.y - newTopLeftPoint.y

    if (needLockProportion) {
        if (newWidth / newHeight > proportion) {
            newTopLeftPoint.x += Math.abs(newWidth - newHeight * proportion)
            newWidth = newHeight * proportion
        } else {
            newTopLeftPoint.y += Math.abs(newHeight - newWidth / proportion)
            newHeight = newWidth / proportion
        }

        // ç”±äºç°åœ¨æ±‚çš„æœªæ—‹è½¬å‰çš„åæ ‡æ˜¯ä»¥æ²¡æŒ‰æ¯”ä¾‹ç¼©å‡å®½é«˜å‰çš„åæ ‡æ¥è®¡ç®—çš„
        // æ‰€ä»¥ç¼©å‡å®½é«˜åï¼Œéœ€è¦æŒ‰ç…§åŸæ¥çš„ä¸­å¿ƒç‚¹æ—‹è½¬å›å»ï¼Œè·å¾—ç¼©å‡å®½é«˜å¹¶æ—‹è½¬åå¯¹åº”çš„åæ ‡
        // ç„¶åä»¥è¿™ä¸ªåæ ‡å’Œå¯¹ç§°ç‚¹è·å¾—æ–°çš„ä¸­å¿ƒç‚¹ï¼Œå¹¶é‡æ–°è®¡ç®—æœªæ—‹è½¬å‰çš„åæ ‡
        const rotatedTopLeftPoint = calculateRotatedPointCoordinate(newTopLeftPoint, newCenterPoint, style.rotate)
        newCenterPoint = getCenterPoint(rotatedTopLeftPoint, symmetricPoint)
        newTopLeftPoint = calculateRotatedPointCoordinate(rotatedTopLeftPoint, newCenterPoint, -style.rotate)
        newBottomRightPoint = calculateRotatedPointCoordinate(symmetricPoint, newCenterPoint, -style.rotate)
    
        newWidth = newBottomRightPoint.x - newTopLeftPoint.x
        newHeight = newBottomRightPoint.y - newTopLeftPoint.y
    }

    if (newWidth > 0 && newHeight > 0) {
        style.width = Math.round(newWidth)
        style.height = Math.round(newHeight)
        style.left = Math.round(newTopLeftPoint.x)
        style.top = Math.round(newTopLeftPoint.y)
    }
}
```
ä¿æŒå®½é«˜æ¯”è¿›è¡Œæ”¾å¤§ç¼©å°çš„æ•ˆæœå¦‚ä¸‹ï¼š

![](https://panyu97py.github.io/post-images/1613507087355.gif)

å½“ `Group` ç»„ä»¶æœ‰æ—‹è½¬çš„å­ç»„ä»¶æ—¶ï¼Œæ‰éœ€è¦ä¿æŒå®½é«˜æ¯”è¿›è¡Œæ”¾å¤§ç¼©å°ã€‚æ‰€ä»¥åœ¨åˆ›å»º `Group` ç»„ä»¶æ—¶å¯ä»¥åˆ¤æ–­ä¸€ä¸‹å­ç»„ä»¶æ˜¯å¦æœ‰æ—‹è½¬è§’åº¦ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±ä¸éœ€è¦ä¿æŒå®½åº¦æ¯”è¿›è¡Œæ”¾å¤§ç¼©å°ã€‚

```js
isNeedLockProportion() {
    if (this.element.component != 'Group') return false
    const ratates = [0, 90, 180, 360]
    for (const component of this.element.propValue) {
        if (!ratates.includes(mod360(parseInt(component.style.rotate)))) {
            return true
        }
    }

    return false
}
```

#### æ‹†åˆ†åå­ç»„ä»¶æ ·å¼çš„æ¢å¤

å°†å¤šä¸ªç»„ä»¶ç»„åˆåœ¨ä¸€èµ·åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥æ˜¯å°† `Group` ç»„ä»¶è¿›è¡Œæ‹†åˆ†å¹¶æ¢å¤å„ä¸ªå­ç»„ä»¶çš„æ ·å¼ã€‚ä¿è¯æ‹†åˆ†åçš„å­ç»„ä»¶åœ¨å¤–è§‚ä¸Šçš„å±æ€§ä¸å˜ã€‚

è®¡ç®—ä»£ç å¦‚ä¸‹ï¼š
```js
// store
decompose({ curComponent, editor }) {
    const parentStyle = { ...curComponent.style }
    const components = curComponent.propValue
    const editorRect = editor.getBoundingClientRect()

    store.commit('deleteComponent')
    components.forEach(component => {
        decomposeComponent(component, editorRect, parentStyle)
        store.commit('addComponent', { component })
    })
}
        
// å°†ç»„åˆä¸­çš„å„ä¸ªå­ç»„ä»¶æ‹†åˆ†å‡ºæ¥ï¼Œå¹¶è®¡ç®—å®ƒä»¬æ–°çš„ style
export default function decomposeComponent(component, editorRect, parentStyle) {
    // å­ç»„ä»¶ç›¸å¯¹äºæµè§ˆå™¨è§†å£çš„æ ·å¼
    const componentRect = $(`#component${component.id}`).getBoundingClientRect()
    // è·å–å…ƒç´ çš„ä¸­å¿ƒç‚¹åæ ‡
    const center = {
        x: componentRect.left - editorRect.left + componentRect.width / 2,
        y: componentRect.top - editorRect.top + componentRect.height / 2,
    }

    component.style.rotate = mod360(component.style.rotate + parentStyle.rotate)
    component.style.width = parseFloat(component.groupStyle.width) / 100 * parentStyle.width
    component.style.height = parseFloat(component.groupStyle.height) / 100 * parentStyle.height
    // è®¡ç®—å‡ºå…ƒç´ æ–°çš„ top left åæ ‡
    component.style.left = center.x - component.style.width / 2
    component.style.top = center.y - component.style.height / 2
    component.groupStyle = {}
}
```

è¿™æ®µä»£ç çš„å¤„ç†é€»è¾‘ä¸ºï¼š

1. éå† `Group` çš„å­ç»„ä»¶å¹¶æ¢å¤å®ƒä»¬çš„æ ·å¼
2. åˆ©ç”¨ `getBoundingClientRect() ``API` è·å–å­ç»„ä»¶ç›¸å¯¹äºæµè§ˆå™¨è§†å£çš„ `left` `top` `width` `height` å±æ€§ã€‚
3. åˆ©ç”¨è¿™å››ä¸ªå±æ€§è®¡ç®—å‡ºå­ç»„ä»¶çš„ä¸­å¿ƒç‚¹åæ ‡ã€‚
4. ç”±äºå­ç»„ä»¶çš„ `width` `height` å±æ€§æ˜¯ç›¸å¯¹äº `Group` ç»„ä»¶çš„ï¼Œæ‰€ä»¥å°†å®ƒä»¬çš„ç™¾åˆ†æ¯”å€¼å’Œ `Group` ç›¸ä¹˜å¾—å‡ºå…·ä½“æ•°å€¼ã€‚
5. å†ç”¨ä¸­å¿ƒç‚¹ `center(x, y) `å‡å»å­ç»„ä»¶å®½é«˜çš„ä¸€åŠå¾—å‡ºå®ƒçš„ `left` `top` å±æ€§ã€‚

è‡³æ­¤ï¼Œç»„åˆå’Œæ‹†åˆ†å°±è®²è§£å®Œäº†ã€‚

### 19. æ–‡æœ¬ç»„ä»¶
æ–‡æœ¬ç»„ä»¶ `VText` ä¹‹å‰å°±å·²ç»å®ç°è¿‡äº†ï¼Œä½†ä¸å®Œç¾ã€‚ä¾‹å¦‚æ— æ³•å¯¹æ–‡å­—è¿›è¡Œé€‰ä¸­ã€‚ç°åœ¨æˆ‘å¯¹å®ƒè¿›è¡Œäº†é‡å†™ï¼Œè®©å®ƒæ”¯æŒé€‰ä¸­åŠŸèƒ½ã€‚
```js
<template>
    <div v-if="editMode == 'edit'" class="v-text" @keydown="handleKeydown" @keyup="handleKeyup">
        <!-- tabindex >= 0 ä½¿å¾—åŒå‡»æ—¶èšé›†è¯¥å…ƒç´  -->
        <div :contenteditable="canEdit" :class="{ canEdit }" @dblclick="setEdit" :tabindex="element.id" @paste="clearStyle"
            @mousedown="handleMousedown" @blur="handleBlur" ref="text" v-html="element.propValue" @input="handleInput"
            :style="{ verticalAlign: element.style.verticalAlign }"
        ></div>
    </div>
    <div v-else class="v-text">
        <div v-html="element.propValue" :style="{ verticalAlign: element.style.verticalAlign }"></div>
    </div>
</template>

<script>
import { mapState } from 'vuex'
import { keycodes } from '@/utils/shortcutKey.js'

export default {
    props: {
        propValue: {
            type: String,
            require: true,
        },
        element: {
            type: Object,
        },
    },
    data() {
        return {
            canEdit: false,
            ctrlKey: 17,
            isCtrlDown: false,
        }
    },
    computed: {
        ...mapState([
            'editMode',
        ]),
    },
    methods: {
        handleInput(e) {
            this.$emit('input', this.element, e.target.innerHTML)
        },

        handleKeydown(e) {
            if (e.keyCode == this.ctrlKey) {
                this.isCtrlDown = true
            } else if (this.isCtrlDown && this.canEdit && keycodes.includes(e.keyCode)) {
                e.stopPropagation()
            } else if (e.keyCode == 46) { // deleteKey
                e.stopPropagation()
            }
        },

        handleKeyup(e) {
            if (e.keyCode == this.ctrlKey) {
                this.isCtrlDown = false
            }
        },

        handleMousedown(e) {
            if (this.canEdit) {
                e.stopPropagation()
            }
        },

        clearStyle(e) {
            e.preventDefault()
            const clp = e.clipboardData
            const text = clp.getData('text/plain') || ''
            if (text !== '') {
                document.execCommand('insertText', false, text)
            }

            this.$emit('input', this.element, e.target.innerHTML)
        },

        handleBlur(e) {
            this.element.propValue = e.target.innerHTML || '&nbsp;'
            this.canEdit = false
        },

        setEdit() {
            this.canEdit = true
            // å…¨é€‰
            this.selectText(this.$refs.text)
        },

        selectText(element) {
            const selection = window.getSelection()
            const range = document.createRange()
            range.selectNodeContents(element)
            selection.removeAllRanges()
            selection.addRange(range)
        },
    },
}
</script>

<style lang="scss" scoped>
.v-text {
    width: 100%;
    height: 100%;
    display: table;

    div {
        display: table-cell;
        width: 100%;
        height: 100%;
        outline: none;
    }

    .canEdit {
        cursor: text;
        height: 100%;
    }
}
</style>
```
æ”¹é€ åçš„ VText ç»„ä»¶åŠŸèƒ½å¦‚ä¸‹ï¼š

1. åŒå‡»å¯åŠ¨ç¼–è¾‘ã€‚
2. æ”¯æŒé€‰ä¸­æ–‡æœ¬ã€‚
3. ç²˜è´´æ—¶è¿‡æ»¤æ‰æ–‡æœ¬çš„æ ·å¼ã€‚
4. æ¢è¡Œæ—¶è‡ªåŠ¨æ‰©å……æ–‡æœ¬æ¡†çš„é«˜åº¦ã€‚

![](https://panyu97py.github.io/post-images/1613507304088.gif)

### 20. çŸ©å½¢ç»„ä»¶

çŸ©å½¢ç»„ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªå†…åµŒ `VText` æ–‡æœ¬ç»„ä»¶çš„ä¸€ä¸ª `DIV`

```js
<template>
    <div class="rect-shape">
        <v-text :propValue="element.propValue" :element="element" />
    </div>
</template>

<script>
export default {
    props: {
        element: {
            type: Object,
        },
    },
}
</script>

<style lang="scss" scoped>
.rect-shape {
    width: 100%;
    height: 100%;
    overflow: auto;
}
</style>
```
`VText` æ–‡æœ¬ç»„ä»¶æœ‰çš„åŠŸèƒ½å®ƒéƒ½æœ‰ï¼Œå¹¶ä¸”å¯ä»¥ä»»æ„æ”¾å¤§ç¼©å°ã€‚

![](https://panyu97py.github.io/post-images/1613507388868.gif)

### 21. é”å®šç»„ä»¶

é”å®šç»„ä»¶ä¸»è¦æ˜¯çœ‹åˆ° `processon` å’Œå¢¨åˆ€æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œäºæ˜¯æˆ‘é¡ºä¾¿å®ç°äº†ã€‚é”å®šç»„ä»¶çš„å…·ä½“éœ€æ±‚ä¸ºï¼šä¸èƒ½ç§»åŠ¨ã€æ”¾å¤§ç¼©å°ã€æ—‹è½¬ã€å¤åˆ¶ã€ç²˜è´´ç­‰ï¼Œåªèƒ½è¿›è¡Œè§£é”æ“ä½œã€‚
å®ƒçš„å®ç°åŸç†ä¹Ÿä¸éš¾ï¼š

1. åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸ŠåŠ ä¸€ä¸ª `isLock` å±æ€§ï¼Œè¡¨ç¤ºæ˜¯å¦é”å®šç»„ä»¶ã€‚
2. åœ¨ç‚¹å‡»ç»„ä»¶æ—¶ï¼Œæ ¹æ® `isLock` æ˜¯å¦ä¸º `true` æ¥éšè—ç»„ä»¶ä¸Šçš„å…«ä¸ªç‚¹å’Œæ—‹è½¬å›¾æ ‡ã€‚
3. ä¸ºäº†çªå‡ºä¸€ä¸ªç»„ä»¶è¢«é”å®šï¼Œç»™å®ƒåŠ ä¸Šé€æ˜åº¦å±æ€§å’Œä¸€ä¸ªé”çš„å›¾æ ‡ã€‚
4. å¦‚æœç»„ä»¶è¢«é”å®šï¼Œç½®ç°ä¸Šé¢æ‰€è¯´çš„éœ€æ±‚å¯¹åº”çš„æŒ‰é’®ï¼Œä¸èƒ½è¢«ç‚¹å‡»ã€‚

ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š
```js
export const commonAttr = {
    animations: [],
    events: {},
    groupStyle: {}, // å½“ä¸€ä¸ªç»„ä»¶æˆä¸º Group çš„å­ç»„ä»¶æ—¶ä½¿ç”¨
    isLock: false, // æ˜¯å¦é”å®šç»„ä»¶
}
```

```html
<el-button @click="decompose" 
:disabled="!curComponent || curComponent.isLock || curComponent.component != 'Group'">æ‹†åˆ†</el-button>

<el-button @click="lock" :disabled="!curComponent || curComponent.isLock">é”å®š</el-button>
<el-button @click="unlock" :disabled="!curComponent || !curComponent.isLock">è§£é”</el-button>
```

```html
<template>
    <div class="contextmenu" v-show="menuShow" :style="{ top: menuTop + 'px', left: menuLeft + 'px' }">
        <ul @mouseup="handleMouseUp">
            <template v-if="curComponent">
                <template v-if="!curComponent.isLock">
                    <li @click="copy">å¤åˆ¶</li>
                    <li @click="paste">ç²˜è´´</li>
                    <li @click="cut">å‰ªåˆ‡</li>
                    <li @click="deleteComponent">åˆ é™¤</li>
                    <li @click="lock">é”å®š</li>
                    <li @click="topComponent">ç½®é¡¶</li>
                    <li @click="bottomComponent">ç½®åº•</li>
                    <li @click="upComponent">ä¸Šç§»</li>
                    <li @click="downComponent">ä¸‹ç§»</li>
                </template>
                <li v-else @click="unlock">è§£é”</li>
            </template>
            <li v-else @click="paste">ç²˜è´´</li>
        </ul>
    </div>
</template>
```

![](https://panyu97py.github.io/post-images/1613507515799.gif)

### 22. å¿«æ·é”®

æ”¯æŒå¿«æ·é”®ä¸»è¦æ˜¯ä¸ºäº†æå‡å¼€å‘æ•ˆç‡ï¼Œç”¨é¼ æ ‡ç‚¹ç‚¹ç‚¹æ¯•ç«Ÿæ²¡æœ‰æŒ‰é”®ç›˜å¿«ã€‚ç›®å‰å¿«æ·é”®æ”¯æŒçš„åŠŸèƒ½å¦‚ä¸‹ï¼š
```
const ctrlKey = 17, 
    vKey = 86, // ç²˜è´´
    cKey = 67, // å¤åˆ¶
    xKey = 88, // å‰ªåˆ‡

    yKey = 89, // é‡åš
    zKey = 90, // æ’¤é”€

    gKey = 71, // ç»„åˆ
    bKey = 66, // æ‹†åˆ†

    lKey = 76, // é”å®š
    uKey = 85, // è§£é”

    sKey = 83, // ä¿å­˜
    pKey = 80, // é¢„è§ˆ
    dKey = 68, // åˆ é™¤
    deleteKey = 46, // åˆ é™¤
    eKey = 69 // æ¸…ç©ºç”»å¸ƒ
```

å®ç°åŸç†ä¸»è¦æ˜¯åˆ©ç”¨ `window` å…¨å±€ç›‘å¬æŒ‰é”®äº‹ä»¶ï¼Œåœ¨ç¬¦åˆæ¡ä»¶çš„æŒ‰é”®è§¦å‘æ—¶æ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼š

```js
// ä¸ç»„ä»¶çŠ¶æ€æ— å…³çš„æ“ä½œ
const basemap = {
    [vKey]: paste,
    [yKey]: redo,
    [zKey]: undo,
    [sKey]: save,
    [pKey]: preview,
    [eKey]: clearCanvas,
}

// ç»„ä»¶é”å®šçŠ¶æ€ä¸‹å¯ä»¥æ‰§è¡Œçš„æ“ä½œ
const lockMap = {
    ...basemap,
    [uKey]: unlock,
}

// ç»„ä»¶æœªé”å®šçŠ¶æ€ä¸‹å¯ä»¥æ‰§è¡Œçš„æ“ä½œ
const unlockMap = {
    ...basemap,
    [cKey]: copy,
    [xKey]: cut,
    [gKey]: compose,
    [bKey]: decompose,
    [dKey]: deleteComponent,
    [deleteKey]: deleteComponent,
    [lKey]: lock,
}

let isCtrlDown = false
// å…¨å±€ç›‘å¬æŒ‰é”®æ“ä½œå¹¶æ‰§è¡Œç›¸åº”å‘½ä»¤
export function listenGlobalKeyDown() {
    window.onkeydown = (e) => {
        const { curComponent } = store.state
        if (e.keyCode == ctrlKey) {
            isCtrlDown = true
        } else if (e.keyCode == deleteKey && curComponent) {
            store.commit('deleteComponent')
            store.commit('recordSnapshot')
        } else if (isCtrlDown) {
            if (!curComponent || !curComponent.isLock) {
                e.preventDefault()
                unlockMap[e.keyCode] && unlockMap[e.keyCode]()
            } else if (curComponent && curComponent.isLock) {
                e.preventDefault()
                lockMap[e.keyCode] && lockMap[e.keyCode]()
            }
        }
    }

    window.onkeyup = (e) => {
        if (e.keyCode == ctrlKey) {
            isCtrlDown = false
        }
    }
}

```

ä¸ºäº†é˜²æ­¢å’Œæµè§ˆå™¨é»˜è®¤å¿«æ·é”®å†²çªï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š `e.preventDefault()`ã€‚

### 23. ç½‘æ ¼çº¿
ç½‘æ ¼çº¿åŠŸèƒ½ä½¿ç”¨ `SVG` æ¥å®ç°ï¼š
```html
<template>
    <svg class="grid" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <pattern id="smallGrid" width="7.236328125" height="7.236328125" patternUnits="userSpaceOnUse">
                <path 
                    d="M 7.236328125 0 L 0 0 0 7.236328125" 
                    fill="none" 
                    stroke="rgba(207, 207, 207, 0.3)" 
                    stroke-width="1">
                </path>
            </pattern>
            <pattern id="grid" width="36.181640625" height="36.181640625" patternUnits="userSpaceOnUse">
                <rect width="36.181640625" height="36.181640625" fill="url(#smallGrid)"></rect>
                <path 
                    d="M 36.181640625 0 L 0 0 0 36.181640625" 
                    fill="none" 
                    stroke="rgba(186, 186, 186, 0.5)" 
                    stroke-width="1">
                </path>
            </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#grid)"></rect>
    </svg>
</template>

<style lang="scss" scoped>
.grid {
    position: absolute;
    top: 0;
    left: 0;
}
</style>

```
å¯¹ SVG ä¸å¤ªæ‡‚çš„ï¼Œå»ºè®®çœ‹ä¸€ä¸‹ [MDN çš„æ•™ç¨‹](https://developer.mozilla.org/zh-CN/docs/Web/SVG)ã€‚

### 24. ç¼–è¾‘å™¨å¿«ç…§çš„å¦ä¸€ç§å®ç°æ–¹å¼
åœ¨ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ä¸­ï¼Œæˆ‘å·²ç»åˆ†æè¿‡å¿«ç…§çš„å®ç°åŸç†ã€‚
```js
snapshotData: [], // ç¼–è¾‘å™¨å¿«ç…§æ•°æ®
snapshotIndex: -1, // å¿«ç…§ç´¢å¼•
        
undo(state) {
    if (state.snapshotIndex >= 0) {
        state.snapshotIndex--
        store.commit('setComponentData', deepCopy(state.snapshotData[state.snapshotIndex]))
    }
},

redo(state) {
    if (state.snapshotIndex < state.snapshotData.length - 1) {
        state.snapshotIndex++
        store.commit('setComponentData', deepCopy(state.snapshotData[state.snapshotIndex]))
    }
},

setComponentData(state, componentData = []) {
    Vue.set(state, 'componentData', componentData)
},

recordSnapshot(state) {
    // æ·»åŠ æ–°çš„å¿«ç…§
    state.snapshotData[++state.snapshotIndex] = deepCopy(state.componentData)
    // åœ¨ undo è¿‡ç¨‹ä¸­ï¼Œæ·»åŠ æ–°çš„å¿«ç…§æ—¶ï¼Œè¦å°†å®ƒåé¢çš„å¿«ç…§æ¸…ç†æ‰
    if (state.snapshotIndex < state.snapshotData.length - 1) {
        state.snapshotData = state.snapshotData.slice(0, state.snapshotIndex + 1)
    }
},
```
ç”¨ä¸€ä¸ªæ•°ç»„æ¥ä¿å­˜ç¼–è¾‘å™¨çš„å¿«ç…§æ•°æ®ã€‚ä¿å­˜å¿«ç…§å°±æ˜¯ä¸åœåœ°æ‰§è¡Œ `push()` æ“ä½œï¼Œå°†å½“å‰çš„ç¼–è¾‘å™¨æ•°æ®æ¨å…¥ `snapshotData` æ•°ç»„ï¼Œå¹¶å¢åŠ å¿«ç…§ç´¢å¼• `snapshotIndexã€‚`
ç”±äºæ¯ä¸€æ¬¡æ·»åŠ å¿«ç…§éƒ½æ˜¯å°†å½“å‰ç¼–è¾‘å™¨çš„æ‰€æœ‰ç»„ä»¶æ•°æ®æ¨å…¥ `snapshotData`ï¼Œä¿å­˜çš„å¿«ç…§æ•°æ®è¶Šå¤šå ç”¨çš„å†…å­˜å°±è¶Šå¤šã€‚å¯¹æ­¤æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼š

1. é™åˆ¶å¿«ç…§æ­¥æ•°ï¼Œä¾‹å¦‚åªèƒ½ä¿å­˜ 50 æ­¥çš„å¿«ç…§æ•°æ®ã€‚
2. ä¿å­˜å¿«ç…§åªä¿å­˜å·®å¼‚éƒ¨åˆ†ã€‚

ç°åœ¨è¯¦ç»†æè¿°ä¸€ä¸‹ç¬¬äºŒä¸ªè§£å†³æ–¹æ¡ˆã€‚
å‡è®¾ä¾æ¬¡å¾€ç”»å¸ƒä¸Šæ·»åŠ  a b c d å››ä¸ªç»„ä»¶ï¼Œåœ¨åŸæ¥çš„å®ç°ä¸­ï¼Œå¯¹åº”çš„ `snapshotData` æ•°æ®ä¸ºï¼š

```
// snapshotData
[
  [a],
  [a, b],
  [a, b, c],
  [a, b, c, d],
]
```

ä»ä¸Šé¢çš„ä»£ç å¯ä»¥å‘ç°ï¼Œæ¯ä¸€ç›¸é‚»çš„å¿«ç…§ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ•°æ®æ˜¯ä¸åŒçš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸€æ­¥çš„å¿«ç…§æ·»åŠ ä¸€ä¸ªç±»å‹å­—æ®µï¼Œç”¨æ¥è¡¨ç¤ºæ­¤æ¬¡æ“ä½œæ˜¯æ·»åŠ è¿˜æ˜¯åˆ é™¤ã€‚

é‚£ä¹ˆä¸Šé¢æ·»åŠ å››ä¸ªç»„ä»¶çš„æ“ä½œï¼Œæ‰€å¯¹åº”çš„ `snapshotData` æ•°æ®ä¸ºï¼š

```
// snapshotData
[
  [{ type: 'add', value: a }],
  [{ type: 'add', value: b }],
  [{ type: 'add', value: c }],
  [{ type: 'add', value: d }],
]
```

å¦‚æœæˆ‘ä»¬è¦åˆ é™¤ c ç»„ä»¶ï¼Œé‚£ä¹ˆ `snapshotData` æ•°æ®å°†å˜ä¸ºï¼š

```
// snapshotData
[
  [{ type: 'add', value: a }],
  [{ type: 'add', value: b }],
  [{ type: 'add', value: c }],
  [{ type: 'add', value: d }],
  [{ type: 'remove', value: c }],
]
```

é‚£å¦‚ä½•ä½¿ç”¨ç°åœ¨çš„å¿«ç…§æ•°æ®å‘¢ï¼Ÿ

æˆ‘ä»¬éœ€è¦éå†ä¸€éå¿«ç…§æ•°æ®ï¼Œæ¥ç”Ÿæˆç¼–è¾‘å™¨çš„ç»„ä»¶æ•°æ® `componentData`ã€‚å‡è®¾åœ¨ä¸Šé¢çš„æ•°æ®åŸºç¡€ä¸Šæ‰§è¡Œäº† `undo` æ’¤é”€æ“ä½œï¼š

```
// snapshotData
// å¿«ç…§ç´¢å¼• snapshotIndex æ­¤æ—¶ä¸º 3
[
  [{ type: 'add', value: a }],
  [{ type: 'add', value: b }],
  [{ type: 'add', value: c }],
  [{ type: 'add', value: d }],
  [{ type: 'remove', value: c }],
]
```

1. snapshotData[0] ç±»å‹ä¸º addï¼Œå°†ç»„ä»¶ a æ·»åŠ åˆ° componentData ä¸­ï¼Œæ­¤æ—¶ componentData ä¸º [a]
2. ä¾æ¬¡ç±»æ¨ [a, b]
3. [a, b, c]
4. [a, b, c, d]

å¦‚æœè¿™æ—¶æ‰§è¡Œ `redo` é‡åšæ“ä½œï¼Œå¿«ç…§ç´¢å¼• `snapshotIndex` å˜ä¸º 4ã€‚å¯¹åº”çš„å¿«ç…§æ•°æ®ç±»å‹ä¸º `type: 'remove'`ï¼Œ ç§»é™¤ç»„ä»¶ cã€‚åˆ™æ•°ç»„æ•°æ®ä¸º` [a, b, d]`ã€‚
è¿™ç§æ–¹æ³•å…¶å®å°±æ˜¯æ—¶é—´æ¢ç©ºé—´ï¼Œè™½ç„¶æ¯ä¸€æ¬¡ä¿å­˜çš„å¿«ç…§æ•°æ®åªæœ‰ä¸€é¡¹ï¼Œä½†æ¯æ¬¡éƒ½å¾—éå†ä¸€éæ‰€æœ‰çš„å¿«ç…§æ•°æ®ã€‚ä¸¤ç§æ–¹æ³•éƒ½ä¸å®Œç¾ï¼Œè¦ä½¿ç”¨å“ªç§å–å†³äºä½ ï¼Œç›®å‰æˆ‘ä»åœ¨ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ã€‚